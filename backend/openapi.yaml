
openapi: 3.0.3
info:
  title: Expense Reimbursement System API (Synced Schemas)
  version: 2.0.0
  description: >
    API definitions generated from current Pydantic schemas for Employee, Expense, Policy, and AuditLog.
    All request and response bodies strictly match the Python schema definitions.
servers:
  - url: https://localhost:8081/api/v1
    description: Local test server

security:
  - firebaseAuth: []

components:
  securitySchemes:
    firebaseAuth:
      type: http
      scheme: bearer
      bearerFormat: FirebaseIDToken
      description: |
        Provide Firebase ID Token in the Authorization header.
        Example: `Bearer eyJhbGciOiJ...`

  schemas:
    EmployeeCreate:
      type: object
      required: [authentication_id, email, name, position, role]
      properties:
        authentication_id: { type: string }
        email: { type: string }
        name: { type: string }
        position: { type: string }
        role: { type: string, enum: ["employee", "admin"], default: "employee" }
        bank_account: { type: string, nullable: true }
        notes: { type: string, nullable: true }

    EmployeeOut:
      allOf:
        - $ref: '#/components/schemas/EmployeeCreate'
        - type: object
          required: [employee_id]
          properties:
            employee_id: { type: string }

    ExpenseCreate:
      type: object
      required: [employee_id, amount, category]
      properties:
        employee_id: { type: string }
        amount: { type: number }
        category: { type: string }
        description: { type: string, default: "" }
        receipt_url: { type: string, format: uri, nullable: true }

    ExpenseOut:
      allOf:
        - $ref: '#/components/schemas/ExpenseCreate'
        - type: object
          required: [expense_id, status, decision_type, submitted_at, updated_at]
          properties:
            expense_id: { type: string }
            status: { type: string, enum: ["pending", "approved", "rejected"] }
            decision_type: { type: string, enum: ["AI", "Human"] }
            reviewed_by: { type: string, nullable: true }
            decision_reason: { type: string, nullable: true }
            submitted_at: { type: string, format: date-time }
            updated_at: { type: string, format: date-time }

    PolicyCreate:
      type: object
      required: [category, max_amount]
      properties:
        category: { type: string }
        max_amount: { type: number }
        eligible_roles:
          type: array
          items: { type: string }
          default: ["employee"]
        description: { type: string, nullable: true }
        active: { type: boolean, default: true }

    PolicyOut:
      allOf:
        - $ref: '#/components/schemas/PolicyCreate'
        - type: object
          required: [policy_id]
          properties:
            policy_id: { type: string }

    AuditLogCreate:
      type: object
      required: [actor, action, target_type]
      properties:
        actor: { type: string }
        action: { type: string, enum: ["create", "update", "delete"] }
        target_type: { type: string, enum: ["expense", "employee", "policy"] }
        target_id: { type: string, nullable: true }
        log_notes: { type: string, nullable: true }
        action_type: { type: string, nullable: true }

    AuditLogOut:
      allOf:
        - $ref: '#/components/schemas/AuditLogCreate'
        - type: object
          required: [timestamp]
          properties:
            timestamp: { type: string, format: date-time }

paths:
  /employees:
    get:
      tags: [Employee]
      summary: List all employees
      responses:
        '200':
          description: List of employees
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EmployeeOut'
    post:
      tags: [Employee]
      summary: Create new employee
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmployeeCreate'
      responses:
        '201':
          description: Employee created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeOut'

  /employees/{employee_id}:
    get:
      tags: [Employee]
      summary: Get employee by ID
      parameters:
        - name: employee_id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Employee details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeOut'
    patch:
      tags: [Employee]
      summary: Update employee info
      parameters:
        - name: employee_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmployeeCreate'
      responses:
        '200':
          description: Employee updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeOut'

  /expenses:
    get:
      tags: [Expense]
      summary: List all expenses
      responses:
        '200':
          description: List of expenses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExpenseOut'
    post:
      tags: [Expense]
      summary: Create new expense
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExpenseCreate'
      responses:
        '201':
          description: Expense created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpenseOut'

  /expenses/{expense_id}:
    get:
      tags: [Expense]
      summary: Get expense by ID
      parameters:
        - name: expense_id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Expense details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpenseOut'
    patch:
      tags: [Expense]
      summary: Update expense
      parameters:
        - name: expense_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExpenseCreate'
      responses:
        '200':
          description: Expense updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpenseOut'

  /policies:
    get:
      tags: [Policy]
      summary: List reimbursement policies
      responses:
        '200':
          description: List of policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PolicyOut'
    post:
      tags: [Policy]
      summary: Create new policy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyCreate'
      responses:
        '201':
          description: Policy created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyOut'

  /policies/{policy_id}:
    patch:
      tags: [Policy]
      summary: Update policy
      parameters:
        - name: policy_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyCreate'
      responses:
        '200':
          description: Policy updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyOut'

  /audit_logs:
    get:
      tags: [AuditLog]
      summary: List all audit logs
      responses:
        '200':
          description: List of audit logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLogOut'
    post:
      tags: [AuditLog]
      summary: Record new audit log entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditLogCreate'
      responses:
        '201':
          description: Audit log created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogOut'
